---
title: "Semiparametric Difference in Differences Estimators using the LASSO"
author:  'Apoorva Lal'
date: \today
output: github_document
---

```{r, echo=FALSE, include=FALSE}
library(LalRUtils)
libreq(glmnet, knitr)
set.seed(666)
source("R/spDID.R")

knitr::opts_chunk$set(fig.width=12, fig.height=8, cache = TRUE, echo=TRUE,
  warning=FALSE, message=FALSE)
```

## DGP

```{r}
# %% # DGP
simstudy = \(N=200, p=100, s=5, theta=3){
    γ=c(s:1,rep(0,(p-s)))/s
    X=array(rnorm(N*p,0,1),dim=c(N,p))
    pr = 1/(1+exp(-X%*%γ))
    D  = rbinom(N,1,pr)
    beta1 = γ+0.5; beta2 = γ+1;
    # potential outcomes
    ε1 = rnorm(N,0,0.1); ε2 = ε3 = ε1
    Y11=Y01=Y00=rep(NA, N)
    Y00 = X %*% beta1 + ε1
    Y01 = Y00 + 1 + ε2
    Y11 = theta + Y01 +ε3
    # outcomes at two time periods
    Y0 = Y00
    Y1 = Y01*(1-D) + Y11*D
    data.frame(Y1, Y0, D, X)
}

```{r}
B = 100

tauhats1 = mcReplicate(B, {
    df = simstudy()
    ipwDID(df[, -(1:3)] %>% as.matrix(), df$D, df$Y1, df$Y0, xfit = F)
  }, mc.cores = 8)
tauhats2 = mcReplicate(B, {
    df = simstudy()
    ipwDID(df[, -(1:3)] %>% as.matrix(), df$D, df$Y1, df$Y0, xfit = T)
  }, mc.cores = 8)

tauhats3 = mcReplicate(B, {
    df = simstudy()
    aipwDID(df[, -(1:3)] %>% as.matrix(), df$D, df$Y1, df$Y0, xfit = F)
  }, mc.cores = 8)

tauhats4 = mcReplicate(B, {
    df = simstudy()
    aipwDID(df[, -(1:3)] %>% as.matrix(), df$D, df$Y1, df$Y0, xfit = T)
  }, mc.cores = 8)
```

```{r}
θ = 3
ests = c(tauhats1, tauhats2, tauhats3, tauhats4)
bounds = quantile(ests, c(0.05, 0.95))
lb = min(2.8, bounds[1]); ub = max(3.2, bounds[2])

par(mfrow = c(2, 2))
hist(tauhats1, breaks=100, main="FS: IPW", xlab="", ylab="", xlim = c(lb, ub))
abline(v = mean(tauhats1), col = 'blue'); abline(v = θ, col = 'red')
hist(tauhats2, breaks=100, main="XF: IPW",     xlab="", ylab="", xlim = c(lb, ub))
abline(v = mean(tauhats2), col = 'blue'); abline(v = θ, col = 'red')

hist(tauhats3, breaks=100, main="FS: AIPW",    xlab="", ylab="", xlim = c(lb, ub))
abline(v = mean(tauhats3), col = 'blue'); abline(v = θ, col = 'red')
hist(tauhats4, breaks=100, main="XF: AIPW",    xlab="", ylab="", xlim = c(lb, ub))
abline(v = mean(tauhats4), col = 'blue'); abline(v = θ, col = 'red')
# %%
```
